C51 COMPILER V9.01   MAIN                                                                  08/30/2016 11:03:52 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(..\Listing\main.lst) OBJECT(..\Ou
                    -tput\main.obj)

line level    source

   1          /**********************************************************************************
   2           * 工程名  :拨打电话
   3           * 描述    :通过C51开发板控制模块拨打指定电话号
   4           * 实验平台:C51
   5           * 库版本  :
   6           * 作者    :泥人通信模块开发平台团队 
   7          
   8          
   9           * 硬件连接说明
  10                   使用单片串口与GPRS模块通信 
  11                   C51        GPRS模块
  12                   P30 (RXD)->RXD
  13                   P31 (TXD)->TXD
  14                   GND        ->GND
  15          
  16           * 软件功能说明
  17             板子上电后运行指示灯RUNING_LED会以一秒的频率闪烁
  18                   插上耳机，程序运行后可以听到拨通了10086的客户电话
  19                   通过修改*phone = "ATD10086;\r\n"可以修改拨叫方电话
  20          **********************************************************************************/
  21          #include "config.h"
  22          #include "string.h"
  23          #include "delay.h"
  24          #include "uart.h"
  25          
  26          #define Buf1_Max 200                                      //串口缓存长度
  27          /*************  本地常量声明    **************/
  28          sbit RUNING_LED = P1^2;                                 //运行指示灯
  29          
  30          
  31          /*************  本地变量声明    **************/
  32          xdata u8 Uart1_Buf[Buf1_Max];
  33          
  34          u8 Times=0,First_Int = 0,shijian=0;
  35          bdata u8 Flag;//定时器标志位
  36          sbit Timer0_start =Flag^0;      //定时器0延时启动计数器
  37          
  38          static unsigned char *phone = "ATD13798983973;\r\n"; //拨打电话，修改这里可以修改拨打的电话。
  39          
  40          /*************  本地函数声明    **************/
  41          void GPIO_config(void); //引脚初始化
  42          void Timer0Init(void);  //定时器0初始化
  43          void CLR_Buf1(void);    //清串口接收缓存
  44          void Wait_CREG(void);   //查询等待模块注册完成
  45          
  46          /*************  外部函数和变量声明*****************/
  47          
  48          
  49          
  50          
  51          /*******************************************************************************
  52          * 函数名 : main 
  53          * 描述   : 主函数
  54          * 输入   : 
C51 COMPILER V9.01   MAIN                                                                  08/30/2016 11:03:52 PAGE 2   

  55          * 输出   : 
  56          * 返回   : 
  57          * 注意   : 串口波特率是9600，GPRS模块默认波特率是115200，需要自己通过串口助手修改
  58                                             为9600方可使用。
  59          *******************************************************************************/
  60          void main(void)
  61          {
  62   1        Timer0Init();  //初始化定时器0
  63   1              GPIO_config();
  64   1              EA=1;   //开总中断
  65   1              Uart1Init();  //初始化串口9600
  66   1              Wait_CREG();  //查询模块是否注册成功
  67   1        UART1_SendString(phone);  //拨打电话
  68   1              while(1)
  69   1              {
  70   2                      ;
  71   2              }
  72   1              
  73   1      }
  74          
  75          /*******************************************************************************
  76          * 函数名 : Uart1 
  77          * 描述   : 串口1中断服务入口函数
  78          * 输入   : 
  79          * 输出   : 
  80          * 返回   : 
  81          * 注意   : 
  82          *******************************************************************************/
  83          void Uart1() interrupt 4
  84          {
  85   1          if (RI)
  86   1          {
  87   2            RI = 0;                 //清除RI位
  88   2                              Uart1_Buf[First_Int] = SBUF;      //将接收到的字符串存到缓存中
  89   2                              First_Int++;                                    //缓存指针向后移动
  90   2                              if(First_Int > Buf1_Max)                //如果缓存满,将缓存指针指向缓存的首地址
  91   2                              {
  92   3                                      First_Int = 0;
  93   3                              }
  94   2          }
  95   1          if (TI)
  96   1          {
  97   2              TI = 0;                 //清除TI位
  98   2          }
  99   1      }
 100          /*******************************************************************************
 101          * 函数名 : Timer0_ISR
 102          * 描述   : 定时器0中断服务入口函数,20ms中断一次
 103          * 输入   : 
 104          * 输出   : 
 105          * 返回   : 
 106          * 注意   : 
 107          *******************************************************************************/
 108          void Timer0_ISR() interrupt 1
 109          {
 110   1              static u8 Time_count=0;
 111   1              TL0 = 0x00;             //设置定时初值
 112   1              TH0 = 0xDC;             //设置定时初值
 113   1              TR0=0;//关定时器
 114   1              Time_count++;
 115   1              if(count_20ms) //20ms延时计数器
 116   1                      count_20ms--;
C51 COMPILER V9.01   MAIN                                                                  08/30/2016 11:03:52 PAGE 3   

 117   1              if(Time_count>=100)
 118   1              {
 119   2                      Time_count = 0;
 120   2                      RUNING_LED =~RUNING_LED;
 121   2              }
 122   1      
 123   1              TR0=1;//开定时器
 124   1      }
 125          
 126          /*******************************************************************************
 127          * 函数名 : GPIO_config
 128          * 描述   : IO口配置函数
 129          * 输入   : 
 130          * 输出   : 
 131          * 返回   : 
 132          * 注意   : 
 133          *******************************************************************************/
 134          void    GPIO_config(void)
 135          {
 136   1                      RUNING_LED=0;
 137   1      }
 138          /*******************************************************************************
 139          * 函数名 : Timer0Init
 140          * 描述   : 定时器0初始化，20ms定时
 141          * 输入   : 
 142          * 输出   : 
 143          * 返回   : 
 144          * 注意   : 
 145          *******************************************************************************/
 146          void Timer0Init(void)           //10毫秒@11.0592MHz
 147          {
 148   1              AUXR &= 0x7F;           //定时器时钟12T模式
 149   1              TMOD &= 0xF0;           //设置定时器模式
 150   1              TMOD |= 0x01;           //设置定时器模式
 151   1              TL0 = 0x00;             //设置定时初值
 152   1              TH0 = 0xDC;             //设置定时初值
 153   1              TF0 = 0;                //清除TF0标志
 154   1              TR0 = 1;                //定时器0开始计时
 155   1              ET0 = 1;          //使能定时器0中断
 156   1      }
 157          /*******************************************************************************
 158          * 函数名 : CLR_Buf1
 159          * 描述   : 清除串口2缓存数据
 160          * 输入   : 
 161          * 输出   : 
 162          * 返回   : 
 163          * 注意   : 
 164          *******************************************************************************/
 165          void CLR_Buf1(void)
 166          {
 167   1              u16 k;
 168   1              for(k=0;k<Buf1_Max;k++)      //将缓存内容清零
 169   1              {
 170   2                      Uart1_Buf[k] = 0x00;
 171   2              }
 172   1          First_Int = 0;              //接收字符串的起始存储位置
 173   1      }
 174          
 175          /*******************************************************************************
 176          * 函数名 : Wait_CREG
 177          * 描述   : 等待模块注册成功
 178          * 输入   : 
C51 COMPILER V9.01   MAIN                                                                  08/30/2016 11:03:52 PAGE 4   

 179          * 输出   : 
 180          * 返回   : 
 181          * 注意   : 
 182          *******************************************************************************/
 183          void Wait_CREG(void)
 184          {
 185   1              u8 i;
 186   1              u8 k;
 187   1              i = 0;
 188   1              CLR_Buf1();
 189   1        while(i == 0)                         
 190   1              {
 191   2                      CLR_Buf1();        
 192   2                      UART1_SendString("AT+CREG?"); //发送查询模块注册状态
 193   2                      UART1_SendLR();
 194   2                      delay_ms(250);//延时5s                                                  
 195   2                  for(k=0;k<Buf1_Max;k++)                             
 196   2              {
 197   3                              if(Uart1_Buf[k] == ':')
 198   3                              {
 199   4                                      if((Uart1_Buf[k+4] == '1')||(Uart1_Buf[k+4] == '5'))  //说模块注册成功
 200   4                                      {
 201   5                                              i = 1;
 202   5                                        break;
 203   5                                      }
 204   4                              }
 205   3                      }
 206   2              }
 207   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    251    ----
   CONSTANT SIZE    =     27    ----
   XDATA SIZE       =    200    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
