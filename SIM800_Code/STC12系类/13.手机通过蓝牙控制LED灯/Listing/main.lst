C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(..\Listing\main.lst) OBJECT(..\Ou
                    -tput\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  :
   3           * ÃèÊö    :Í¨¹ýÊÖ»úÀ¶ÑÀ¿ØÖÆLED
   4                                                          Í¨¹ýSTC¿ª·¢°å´®¿Ú2¿ØÖÆÄ£¿é´ò¿ªÀ¶ÑÀ£¬²¢½«Á¬½Ó¹ý³Ì·¢ËÍµ½´®¿Ú1£»µ±ÓëÊÖ»ú
   5                                                          ½¨Á¢À¶ÑÀSPPÁ¬½Óºó£¬»á¶¨Ê±·¢ËÍ¹Ì¶¨Êý¾Ý¸øÊÖ»úÀ¶ÑÀ´®¿Ú£¬ÊÖ»úÀ¶ÑÀ·¢ËÍµÄÊý¾Ý
   6                                                          »á×Ô¶¯×ª·¢µ½´®¿Ú1¡£
   7                                                          ÔËÐÐ³ÌÐòÇ°£¬½¨ÒéÏÈ´ò¿ªÎÒÃÇÅäÌ×µÄÊÖ»úÀ¶ÑÀ´®¿ÚÖúÊÖ¡£
   8           * ÊµÑéÆ½Ì¨:STC12XX
   9           * ¿â°æ±¾  :
  10           * Èí¼þ¹¦ÄÜËµÃ÷
  11             ´ò¿ªÎÒÃÇÅäÌ×µÄÊÖ»úAPP£¬ÇÐ»»Ä£Ê½µ½¼à¿ØÕ¾Ä£Ê½£¬Í¨¹ý¡°°´¼ü1¡±¾Í¿ÉÒÔ¿ØÖÆLEDµÄÁÁÃð¡£
  12          **********************************************************************************/
  13          
  14          #include "string.h"
  15          #include "delay.h"
  16          #include "uart.h"
  17          
  18          #define Buf1_Max 60                                       //´®¿Ú1»º´æ³¤¶È
  19          #define Buf2_Max 200                                      //´®¿Ú2»º´æ³¤¶È
  20          /*************  ±¾µØ³£Á¿ÉùÃ÷    **************/
  21          sbit RUNING_LED = P1^0;                                 //ÔËÐÐÖ¸Ê¾µÆ
  22          sbit LED                        = P1^1;                                 //¿ØÖÆÖ¸Ê¾µÆ
  23          
  24          const char *sendtable="UNV-elec Bluetooth LED control\r\n\32";
  25          
  26          /*************  ±¾µØ±äÁ¿ÉùÃ÷    **************/
  27          xdata u8 Uart1_Buf[Buf1_Max];
  28          xdata u8 Uart2_Buf[Buf2_Max];
  29          char *p1,*p2; 
  30          
  31          u16 Times=0;
  32          u8 First_Int = 0,shijian=0;
  33          u8 Timer_send;//¶¨Ê±·¢ËÍ¼ÆÊ±Æ÷
  34          //u8 Time_count=0;
  35          bdata u8 Flag;//¶¨Ê±Æ÷±êÖ¾Î»
  36          sbit Timer0_start =Flag^0;      //¶¨Ê±Æ÷0ÑÓÊ±Æô¶¯¼ÆÊýÆ÷
  37          sbit Uart2_Start  =Flag^1;      //´®¿Ú2¿ªÊ¼½ÓÊÕÊý¾Ý
  38          sbit Uart2_End          =Flag^2;        //´®¿Ú2½ÓÊÕÊý¾Ý½áÊø
  39          /*************  ±¾µØº¯ÊýÉùÃ÷    **************/
  40          void GPIO_config(void);
  41          void Timer0Init(void);
  42          void CLR_Buf2(void);
  43          u8 Find(u8 *a);
  44          void Second_AT_Command(u8 *b,char *a,u8 wait_time);
  45          /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷*****************/
  46          /*******************************************************************************
  47          * º¯ÊýÃû : main 
  48          * ÃèÊö   : Ö÷º¯Êý
  49          * ÊäÈë   : 
  50          * Êä³ö   : 
  51          * ·µ»Ø   : 
  52          * ×¢Òâ   : ´®¿Ú2¸ºÔðÓëGPRSÄ£¿éÍ¨ÐÅ£¬´®¿Ú1ÓÃÓÚ´®¿Úµ÷ÊÔ£¬¿ÉÒÔ±ÜÃâÔÚÏÂÔØ³ÌÐòÊ±Êý¾Ý
  53                                                   »¹·¢ËÍµ½Ä£¿é
  54          *******************************************************************************/
C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 2   

  55          void main(void)
  56          {
  57   1              GPIO_config();
  58   1              Uart1Init();
  59   1              Uart2Init();
  60   1              Timer0Init();
  61   1              EA=1;   //¿ª×ÜÖÐ¶Ï
  62   1              UART1_SendString("SIM808Ä£¿éÀ¶ÑÀ²âÊÔ³ÌÐò\r\n");
  63   1              UART1_SendString("Çë´ò¿ªÊÖ»úÀ¶ÑÀ´®¿ÚÖúÊÖ\r\n");
  64   1              UART1_SendString("SIM808Ä£¿éÁ¬½ÓÖÐ\r\n");
  65   1              Second_AT_Command("AT+BTPOWER=1\r\n","AT",2);//´ò¿ªÀ¶ÑÀµçÔ´,Õâ¸ö²»ÅÐ¶ÏOK£¬ÒòÎªµçÔ´Ô­±¾¿ªÆôÔÙ·¢ËÍ´ò¿ªµÄ»°»
             -á·µ»Ø´íÎó
  66   1              delay_ms(100); 
  67   1              Second_AT_Command("AT+BTUNPAIR=0\r\n","AT",2);//É¾³ýÒÑÅä¶ÔµÄÀ¶ÑÀÉèÖÃ,²»ÅÐ¶ÏOK£¬ÒòÎªÃ»ÓÐÒÑÅä¶ÔµÄÉè±¸Ê±·µ»Ø
             -ERROR
  68   1              UART1_SendString("SIM808Ä£¿é¿ªÊ¼ÊÕË÷À¶ÑÀÉè±¸,ÇëÈ·ÈÏÊÖ»úÀ¶ÑÀ´¦ÓÚ¿É±»·¢ÏÖ\r\n");
  69   1          do
  70   1              {
  71   2                      UART1_SendString("ÊÕË÷Éè±¸............\r\n");
  72   2                      Second_AT_Command("AT+BTSCAN=1,10\r\n","+BTSCAN: 1",11);   //ÊÕË÷¸½½üµÄÀ¶ÑÀÉè±¸£¬ÊÕË÷Ê±¼ä10S
  73   2              }while(strstr((const char*)Uart2_Buf,"+BTSCAN: 0")==NULL);   //µÈ´ýÊÕË÷µ½Éè±¸²ÅÍË³ö
  74   1              UART1_SendString("Á¬½ÓµÚÒ»¸öÉè±¸............\r\n");
  75   1              do
  76   1              {
  77   2                      Second_AT_Command("AT+BTPAIR=0,1\r\n","+BTPAIRING:",3);//Á¬½ÓµÚÒ»¸öÊÕË÷µ½µÄÉè±¸ 
  78   2                      delay_ms(200); 
  79   2                      Second_AT_Command("AT+BTPAIR=1,1\r\n","+BTPAIR:",35);//ÏìÓ¦Á¬½Ó,Èç¹ûÊÖ»ú³¤ÆÚ²»È·ÈÏÆ¥Åä£¬ÐèÒª30Sºó²Å»áÉÏ±
             -¨Åä¶ÔÊ§°Ü
  80   2                      delay_ms(100);//µÈ´ý½ÓÊÕÊý¾ÝÍê³É
  81   2              }while(strstr((const char*)Uart2_Buf,"+BTPAIR: 1")==NULL);//Æ¥Åä³É¹¦
  82   1              UART1_SendString("SIM808Ä£¿éÀ¶ÑÀÆ¥Åä³É¹¦\r\n");
  83   1              UART1_SendString("Çë´ò¿ªÊÖ»úÀ¶ÑÀ´®¿ÚÖúÊÖ\r\n");
  84   1              Second_AT_Command("AT+BTGETPROF=1\r\n","BTGETPROF: 4",5);//»ñÈ¡À¶ÑÀ·þÎñÁÐ±í
  85   1              Second_AT_Command("AT+BTCONNECT=1,4\r\n","OK",2);//»ñÈ¡À¶ÑÀ·þÎñÁÐ±í
  86   1              UART1_SendString("SIM808Ä£¿éÀ¶ÑÀ½¨Á¢SPP·þÎñ³É¹¦\r\n");
  87   1              CLR_Buf2(); 
  88   1              while(1)
  89   1              {
  90   2                      //½ÓÊÕµ½Êý¾Ý
  91   2                      if((p1=(char*)strstr((const char*)Uart2_Buf,"DATA:")),(p1!=NULL))//Ñ°ÕÒ¿ªÊ¼·û
  92   2                      {               
  93   3                                      if((p2=(char*)strstr((const char*)p1,"\x0d\x0a")),(p2!=NULL))//Ñ°ÕÒ½áÊø·û
  94   3                                      {
  95   4                                              char *p3;
  96   4                                              *p2=0;//Ìí¼Ó½áÊø·û
  97   4                                              p3=strstr((const char*)p1,",");//ÊÕË÷µÚÒ»¸ö','
  98   4                                              p1=strstr((const char*)p3+1,",");//ÊÕË÷µÚ¶þ¸ö','
  99   4                                              UART1_SendString("½ÓÊÕµ½µÄÄÚÈÝ:");
 100   4                                              UART1_SendString(p1+1);
 101   4                                              UART1_SendLR();
 102   4                                              if(*(p1+4)==(char)0xB1)
 103   4                                              {
 104   5                                                      LED=~LED;
 105   5                                              }
 106   4                                              CLR_Buf2(); 
 107   4                                      }
 108   3                      }else
 109   2                      if(Timer_send>100)//¿ÕÏÐÊ±¶¨Ê±·¢ËÍÊý¾Ý
 110   2                      {       
 111   3                              Second_AT_Command("AT+BTSPPSEND",">",1);
 112   3                              Second_AT_Command((char *)sendtable,"OK",1);
 113   3                              Timer_send=0;
C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 3   

 114   3                      }
 115   2              }       
 116   1      }
 117          /*******************************************************************************
 118          * º¯ÊýÃû : Uart1 
 119          * ÃèÊö   : ´®¿Ú1ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
 120          * ÊäÈë   : 
 121          * Êä³ö   : 
 122          * ·µ»Ø   : 
 123          * ×¢Òâ   : 
 124          *******************************************************************************/
 125          void Uart1() interrupt 4
 126          {
 127   1          if (RI)
 128   1          {
 129   2              RI = 0;                 //Çå³ýRIÎ»
 130   2          }
 131   1          if (TI)
 132   1          {
 133   2              TI = 0;                 //Çå³ýTIÎ»
 134   2          }
 135   1      }
 136          
 137          /*******************************************************************************
 138          * º¯ÊýÃû : Uart2
 139          * ÃèÊö   : ´®¿Ú2ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
 140          * ÊäÈë   : 
 141          * Êä³ö   : 
 142          * ·µ»Ø   : 
 143          * ×¢Òâ   : 
 144          *******************************************************************************/
 145          void Uart2() interrupt 8
 146          {
 147   1                      IE2  &= ~0x01;   //¹Ø±Õ´®¿Ú2ÖÐ¶Ï
 148   1          if (S2CON & S2RI)
 149   1          {
 150   2            S2CON &= ~S2RI;         //Çå³ýS2RIÎ»
 151   2                              Uart2_Buf[First_Int] = S2BUF;     //½«½ÓÊÕµ½µÄ×Ö·û´®´æµ½»º´æÖÐ
 152   2                              First_Int++;                                    //»º´æÖ¸ÕëÏòºóÒÆ¶¯
 153   2                              if(First_Int > Buf2_Max)                //Èç¹û»º´æÂú,½«»º´æÖ¸ÕëÖ¸Ïò»º´æµÄÊ×µØÖ·
 154   2                              {
 155   3                                      First_Int = 0;
 156   3                              }
 157   2          }
 158   1          if (S2CON & S2TI)
 159   1          {
 160   2            S2CON &= ~S2TI;         //Çå³ýS2TIÎ»
 161   2          }
 162   1                      IE2  |= 0x01;   //Ê¹ÄÜ´®¿Ú2ÖÐ¶Ï
 163   1      }
 164          /*******************************************************************************
 165          * º¯ÊýÃû : Timer0_ISR
 166          * ÃèÊö   : ¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñÈë¿Úº¯Êý,20msÖÐ¶ÏÒ»´Î
 167          * ÊäÈë   : 
 168          * Êä³ö   : 
 169          * ·µ»Ø   : 
 170          * ×¢Òâ   : 
 171          *******************************************************************************/
 172          void Timer0_ISR() interrupt 1
 173          {
 174   1              static u8 Time_count=0; 
 175   1              TR0=0;//¹Ø¶¨Ê±Æ÷
C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 4   

 176   1              TF0 = 0;                //Çå³ýTF0±êÖ¾
 177   1              
 178   1              Time_count++;
 179   1              if(Time_count>=50)
 180   1              {
 181   2                      Time_count = 0;
 182   2                      RUNING_LED =~RUNING_LED;
 183   2              }
 184   1              if(Timer0_start)
 185   1              Times++;
 186   1              if(Times > (u16)(50*shijian))
 187   1              {
 188   2                      Timer0_start = 0;
 189   2                      Times = 0;
 190   2              }
 191   1              Timer_send++;
 192   1              
 193   1              TL0 = 0x00;             //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 194   1              TH0 = 0xB8;             //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 195   1              TR0=1;//¿ª¶¨Ê±Æ÷
 196   1              
 197   1              
 198   1      }
 199          /*******************************************************************************
 200          * º¯ÊýÃû : GPIO_config
 201          * ÃèÊö   : IO¿ÚÅäÖÃº¯Êý
 202          * ÊäÈë   : 
 203          * Êä³ö   : 
 204          * ·µ»Ø   : 
 205          * ×¢Òâ   : 
 206          *******************************************************************************/
 207          void    GPIO_config(void)
 208          {
 209   1                      P3M1 &= 0XC3;  //ÅäÖÃP32~P35ÎªÍÆÍìÊä³ö
 210   1                      P3M0 |= ~0XC3;
 211   1                      LED=0;
 212   1                      RUNING_LED=0;
 213   1      }
 214          
 215          void Timer0Init(void)           //20ºÁÃë@11.0592MHz
 216          {
 217   1              AUXR &= 0x7F;           //12TÄ£Ê½
 218   1              TMOD &= 0xF0;           //
 219   1              TMOD |= 0x01;           //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½
 220   1              TL0 = 0x00;             //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 221   1              TH0 = 0xB8;             //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 222   1              TF0 = 0;                //Çå³ýTF0±êÖ¾
 223   1              TR0 = 1;                //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 224   1              ET0 = 1;        //Ê¹ÄÜ¶¨Ê±Æ÷0ÖÐ¶Ï
 225   1      }
 226          
 227          /*******************************************************************************
 228          * º¯ÊýÃû : CLR_Buf2
 229          * ÃèÊö   : Çå³ý´®¿Ú2»º´æÊý¾Ý
 230          * ÊäÈë   : 
 231          * Êä³ö   : 
 232          * ·µ»Ø   : 
 233          * ×¢Òâ   : 
 234          *******************************************************************************/
 235          void CLR_Buf2(void)
 236          {
 237   1              u16 k;
C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 5   

 238   1              for(k=0;k<Buf2_Max;k++)      //½«»º´æÄÚÈÝÇåÁã
 239   1              {
 240   2                      Uart2_Buf[k] = 0x00;
 241   2              }
 242   1          First_Int = 0;              //½ÓÊÕ×Ö·û´®µÄÆðÊ¼´æ´¢Î»ÖÃ
 243   1      }
 244          
 245          /*******************************************************************************
 246          * º¯ÊýÃû : Find
 247          * ÃèÊö   : ÅÐ¶Ï»º´æÖÐÊÇ·ñº¬ÓÐÖ¸¶¨µÄ×Ö·û´®
 248          * ÊäÈë   : 
 249          * Êä³ö   : 
 250          * ·µ»Ø   : unsigned char:1 ÕÒµ½Ö¸¶¨×Ö·û£¬0 Î´ÕÒµ½Ö¸¶¨×Ö·û 
 251          * ×¢Òâ   : 
 252          *******************************************************************************/
 253          
 254          u8 Find(u8 *a)
 255          { 
 256   1        if(strstr(Uart2_Buf,a)!=NULL)
 257   1                  return 1;
 258   1              else
 259   1                              return 0;
 260   1      }
 261          
 262          /*******************************************************************************
 263          * º¯ÊýÃû : Second_AT_Command
 264          * ÃèÊö   : ·¢ËÍATÖ¸Áîº¯Êý
 265          * ÊäÈë   : ·¢ËÍÊý¾ÝµÄÖ¸Õë¡¢·¢ËÍµÈ´ýÊ±¼ä(µ¥Î»£ºS)
 266          * Êä³ö   : 
 267          * ·µ»Ø   : 
 268          * ×¢Òâ   : 
 269          *******************************************************************************/
 270          
 271          void Second_AT_Command(u8 *b,char *a,u8 wait_time)         
 272          {
 273   1              u8 i;
 274   1              u8 *c;
 275   1              c = b;                                                                          //±£´æ×Ö·û´®µØÖ·µ½c
 276   1              CLR_Buf2(); 
 277   1        i = 0;
 278   1              while(i == 0)                    
 279   1              {
 280   2                      if(!Find(a)) 
 281   2                      {
 282   3                              if(Timer0_start == 0)
 283   3                              {
 284   4                                      CLR_Buf2(); 
 285   4                                      b = c;                                                  //½«×Ö·û´®µØÖ·¸øb
 286   4                                      for (b; *b!='\0';b++)
 287   4                                      {
 288   5                                              UART2_SendData(*b);
 289   5                                      }
 290   4                                      UART2_SendLR(); 
 291   4                                      Times = 0;
 292   4                                      shijian = wait_time;
 293   4                                      Timer0_start = 1;
 294   4                         }
 295   3          }
 296   2                else
 297   2                      {
 298   3                              i = 1;
 299   3                              Timer0_start = 0;
C51 COMPILER V9.01   MAIN                                                                  07/25/2016 09:06:43 PAGE 6   

 300   3                      }
 301   2              }
 302   1      }
 303          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    912    ----
   CONSTANT SIZE    =    497    ----
   XDATA SIZE       =    260    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     16      17
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
